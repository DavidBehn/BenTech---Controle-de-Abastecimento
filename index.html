<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>BenTech Controle de Abastecimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background-color: #000; overflow-x: hidden; font-family: Arial, sans-serif; }
    body {
      color: #fff; text-align: center;
      background: linear-gradient(rgba(0,0,0,0.70), rgba(0,0,0,0.70)), url('bg.jpg') center/cover no-repeat fixed;
    }
    }
    body::before {
      content: ""; position: fixed; top: -50%; left: 0; width: 100%; height: 200%;
      background: url('bg.jpg') center/cover no-repeat fixed; z-index: -1;
    }
    @supports (-webkit-touch-callout: none) { html, body { height: -webkit-fill-available; } }

    .header {
      display: flex; align-items: center; justify-content: center; gap: 15px;
      background: rgba(17,17,17,0.9); padding: 12px; margin: 12px;
      margin: 15px auto; border-radius: 12px; width: 90%; max-width: 420px;
    }
    .header img { width: 45px; height: 45px; }
    h1 { margin: 0; font-size: 21px; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%; background: #ff4444;
      box-shadow: 0 0 10px #ff4444; animation: pulse-red 2s infinite;
    }
    .online { background:#00ff88 !important; box-shadow: 0 0 15px #00ff88; animation: pulse-green 2s infinite; }
    @keyframes pulse-red { 0%,100% { opacity: 0.7; } 50% { opacity: 1; } }
    @keyframes pulse-green { 0%,100% { opacity: 0.8; } 50% { opacity: 1; } }

    .card {
      background: rgba(51,51,51,0.7); padding: 22px; margin: 15px auto;
      border-radius: 18px; width: 90%; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .button {
      padding: 16px 30px; margin: 10px; border: none; border-radius: 12px;
      font-size: 18px; cursor: pointer; width: 42%; max-width: 200px;
      transition: all 0.2s; font-weight: bold;
    }
    .on { background: #00ff88; color: #000; }
    .on:active { background: #00cc66; transform: scale(0.97); }
    .off { background: #ff4444; color: #fff; }
    .off:active { background: #cc3333; transform: scale(0.97); }
    select {
      padding: 12px; font-size: 17px; border-radius: 10px; margin-right: 10px; width: 130px;
    }
    .bar {
      background: #444; border-radius: 12px; overflow: hidden; height: 10px auto;
      height: 30px; width: 90%; max-width: 400px;
    }
    .fill {
      background: #00aaff; height: 100%; width: 0%; text-align: center;
      line-height: 30px; font-weight: bold 18px; transition: width 0.6s ease;
    }
    #msg, #saveMsg {
      margin-top: 12px; font-size: 17px; display: none; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.6);
    }
    .inline-group { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="BenTech">
    <h1>Controle de Abastecimento</h1>
    <div id="statusDot" class="status-dot"></div>
  </div>

  <div class="card">
    <h2>Níveis de Reservatório</h2>
    <p>Caixa d'Água</p>
    <div class="bar"><div id="waterTankLevel" class="fill">0%</div></div>
    <p>Reservatório</p>
    <div class="bar"><div id="reservoirLevel" class="fill">0%</div></div>
  </div>

  <p style="font-size:16px;">Obs: Reservatório > 25% para acionamento automático</p>

  <div class="card">
    <h2>Bomba Automática</h2>
    <p>Nível para ligar automaticamente</p>
    <div class="inline-group">
      <select id="selector">
        <option value="0">0%</option>
        <option value="25">25%</option>
        <option value="50">50%</option>
        <option value="75">75%</option>
        <option value="99">OFF</option>
      </select>
      <button class="button on" onclick="saveValue()">Salvar</button>
    </div>
    <p id="saveMsg"></p>
  </div>

  <div class="card">
    <h2>Bomba Manual</h2>
    <button class="button on" onclick="sendCommand('pump:on')">Ligar</button>
    <button class="button off" onclick="sendCommand('pump:off')">Desligar</button>
    <p id="pumpStatus" style="font-size:19px; margin-top:15px; color:#ff4444">Desligado</p>
  </div>

  <div class="card">
    <h2>Dispositivo Paralelo</h2>
    <button class="button on" onclick="sendCommand('device:on')">Ligar</button>
    <button class="button off" onclick="sendCommand('device:off')">Desligar</button>
    <p id="deviceStatus" style="font-size:19px; margin-top:15px; color:#ff4444">Desligado</p>
  </div>

  <script>
    // ===== LEITURA AUTOMÁTICA DO CLIENTE (FORMA 1 + 2) =====
    const urlParams = new URLSearchParams(window.location.search);
    let cliente = urlParams.get('c');
    if (!cliente) {
      cliente = prompt("Digite seu código de cliente (ex: joao2025):");
      if (!cliente) cliente = "teste"; // fallback
    }

    const topicCmd     = `bentech/${cliente}/cmd`;
    const topicStatus  = `bentech/${cliente}/status`;
    const topicTrigger = `bentech/${cliente}/trigger`;

    const client = mqtt.connect('wss://broker.emqx.io:8083/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2,8),
      keepalive: 30,
      reconnectPeriod: 3000,
      clean: false
    });

    const statusDot = document.getElementById('statusDot');
    let lastMsgTime = 0;
    const TIMEOUT = 10000;

    client.on('connect', () => {
      console.log('Conectado como:', cliente);
      statusDot.classList.add('online');
      client.subscribe(topicStatus);
      client.subscribe(topicTrigger);
    });

    client.on('offline', () => statusDot.classList.remove('online'));

    client.on('message', (topic, message) => {
      lastMsgTime = Date.now();
      statusDot.classList.add('online');

      if (topic === topicStatus) {
        try {
          const data = JSON.parse(message.toString());
          updateBar('waterTankLevel', data.waterTankLevel || 0);
          updateBar('reservoirLevel', data.reservoirLevel || 0);
          updateStatus('pumpStatus', data.pumpStatus, 'pumpStatus');
          updateStatus('deviceStatus', data.deviceStatus, 'deviceStatus');
        } catch(e) { console.error(e); }
      }

      if (topic === topicTrigger) {
        let val = parseInt(message.toString());
        if (val >= 99) val = 99;
        document.getElementById('selector').value = val;
      }
    });

    function sendCommand(cmd) {
      client.publish(topicCmd, cmd);
      vibrateDevice();
      if (cmd.includes('on')) {
        updateStatus('pumpStatus', true, 'pumpStatus');
      } else if (cmd.includes('off')) {
        updateStatus('pumpStatus', false, 'pumpStatus');
      }
    }

    function saveValue() {
      const val = document.getElementById('selector').value;
      client.publish(topicCmd, 'trigger:' + val);
      vibrateDevice();
      showMsg('saveMsg', 'Salvo com sucesso!', 2000);
    }

    function vibrateDevice() {
      if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function showMsg(id, text, time = 2000) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', time);
    }

    function updateBar(id, v) {
      const el = document.getElementById(id);
      v = Math.round(v);
      el.style.width = v + '%';
      el.textContent = v + '%';
    }

    function updateStatus(id, state) {
      const el = document.getElementById(id);
      el.textContent = state ? 'Ligado' : 'Desligado';
      el.style.color = state ? '#00ff88' : '#ff4444';
    }

    // Verifica se perdeu conexão
    setInterval(() => {
      if (Date.now() - lastMsgTime > TIMEOUT) {
        statusDot.classList.remove('online');
      }
    }, 5000);
  </script>
</body>
</html>
