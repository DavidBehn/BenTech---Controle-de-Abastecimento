<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Controle de Abastecimento - BenTech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial;text-align:center;
      background:linear-gradient(rgba(0,0,0,.7),rgba(0,0,0,.7)),url('bg.jpg') center/cover fixed}
    body::before{content:"";position:fixed;inset:0;background:url('bg.jpg') center/cover;z-index:-1}
    .header{display:flex;justify-content:center;align-items:center;gap:12px;background:rgba(17,17,17,.9);padding:10px;border-radius:10px;margin:15px auto;width:90%;max-width:405px}
    .header img{width:40px;height:40px}
    h1{font-size:20px;margin:0}
    .status-dot{width:14px;height:14px;border-radius:50%;background:#f44;box-shadow:0 0 10px #f44;animation:pulse-red 2s infinite}
    .online{background:#0f8!important;box-shadow:0 0 15px #0f8!important;animation:pulse-green 2s infinite!important}
    @keyframes pulse-red{0%,100%{opacity:.7}50%{opacity:1}}
    @keyframes pulse-green{0%,100%{opacity:.8}50%{opacity:1}}
    .card{background:rgba(51,51,51,.7);padding:20px;margin:15px auto;border-radius:15px;width:90%;max-width:400px}
    .button{display:inline-block;padding:15px 25px;margin:10px;border:none;border-radius:10px;font-size:18px;cursor:pointer;width:40%;max-width:200px;transition:.15s}
    .on{background:#0f8;color:#000}.on:active{background:#0a5;transform:scale(.97)}
    .off{background:#f44;color:#fff}.off:active{background:#c33;transform:scale(.97)}
    select{padding:10px;font-size:16px;border-radius:8px;width:120px}
    #msg,#saveMsg{margin-top:10px;color:#fff;display:none;font-size:16px}
    .bar{background:#555;border-radius:10px;overflow:hidden;height:25px;margin:10px auto;width:90%;max-width:400px}
    .fill{background:#00aaff;height:100%;width:0%;text-align:center;line-height:25px;color:#fff;transition:width .4s}
    .status-text{font-size:18px;margin-top:5px;font-weight:bold}
    .inline-group{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px;margin-top:10px}
  </style>
</head>
<body>

  <div class="header">
    <img src="logo.png" alt="BenTech">
    <h1>Controle de Abastecimento</h1>
    <div id="statusDot" class="status-dot"></div>
  </div>

  <div class="card">
    <h2>Níveis de Reservatório</h2>
    <p>Caixa d'Água</p><div class="bar"><div id="waterTankLevel" class="fill">0%</div></div>
    <p>Reservatório</p><div class="bar"><div id="reservoirLevel" class="fill">0%</div></div>
  </div>

  <p>Obs: Reservatório acima de 25% para acionamento automático</p>

  <div class="card">
    <h2>Bomba Automática</h2>
    <p>Nível para ligar automaticamente</p>
    <div class="inline-group">
      <select id="selector">
        <option value="0">0%</option>
        <option value="25">25%</option>
        <option value="50">50%</option>
        <option value="75">75%</option>
        <option value="99">OFF</option>
      </select>
      <button class="button on" onclick="saveValue()">Salvar</button>
    </div>
    <p id="saveMsg"></p>
  </div>

  <div class="card">
    <h2>Bomba Manual</h2>
    <button class="button on"  onclick="sendCommand('pump:on',true)">Ligar</button>
    <button class="button off" onclick="sendCommand('pump:off',false)">Desligar</button>
    <p id="msg"></p>
    <p id="pumpStatus" class="status-text" style="color:#ff4444">Desligado</p>
  </div>

  <div class="card">
    <h2>Dispositivo Paralelo</h2>
    <button class="button on"  onclick="sendCommand('device:on',true)">Ligar</button>
    <button class="button off" onclick="sendCommand('device:off',false)">Desligar</button>
    <p id="deviceStatus" class="status-text" style="color:#ff4444">Desligado</p>
  </div>

  <script>
    // BROKER MAIS RÁPIDO DO MUNDO EM 2025 (latência < 250ms no Brasil)
    const mqttBroker = 'wss://broker.hivemq.com:8884/mqtt';
    const clientId   = 'web_' + Date.now();
    const topicCmd     = 'engeasier/david/casa/cmd';
    const topicStatus  = 'engeasier/david/casa/status';
    const topicTrigger = 'engeasier/david/casa/trigger';

    const client = mqtt.connect(mqttBroker, {
      clientId: clientId,
      keepalive: 15,           // mais frequente
      reconnectPeriod: 1000,   // reconecta em 1s
      connectTimeout: 4000,
      clean: true
    });

    let lastMsg = Date.now();
    const TIMEOUT = 12000;

    client.on('connect', () => {
      client.subscribe([topicStatus, topicTrigger]);
      client.publish(topicCmd, 'sync_trigger');
    });

    client.on('message', (topic, message) => {
      lastMsg = Date.now();
      document.getElementById('statusDot').classList.add('online');

      if (topic === topicStatus) {
        try {
          const d = JSON.parse(message.toString());
          updateBar('waterTankLevel', d.waterTankLevel??0);
          updateBar('reservoirLevel', d.reservoirLevel??0);
          updateStatus('pumpStatus', d.pumpStatus);
          updateStatus('deviceStatus', d.deviceStatus);
        } catch(e) {}
      }
      if (topic === topicTrigger) {
        let v = parseInt(message.toString());
        if (v >= 99) v = 99;
        document.getElementById('selector').value = v;
      }
    });

    // Feedback 100% instantâneo (muda ANTES do MQTT responder)
    function sendCommand(cmd, estado) {
      client.publish(topicCmd, cmd);
      if (cmd.includes('pump'))   updateStatus('pumpStatus', estado);
      if (cmd.includes('device')) updateStatus('deviceStatus', estado);
      vibrateDevice();
      showMsg('msg', 'Enviado!');
    }

    function saveValue() {
      const v = document.getElementById('selector').value;
      client.publish(topicCmd, 'trigger:' + v);
      vibrateDevice();
      showMsg('saveMsg', 'Salvo!', 1200);
    }

    function vibrateDevice() { navigator.vibrate?.([50]); }
    function showMsg(id, txt, t = 1500) {
      const el = document.getElementById(id);
      el.textContent = txt; el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', t);
    }
    function updateBar(id, v) {
      v = Math.round(v);
      const el = document.getElementById(id);
      el.style.width = v + '%';
      el.textContent = v + '%';
    }
    function updateStatus(id, state) {
      const el = document.getElementById(id);
      el.textContent = state ? 'Ligado' : 'Desligado';
      el.style.color = state ? '#00ff88' : '#ff4444';
    }

    // Verifica offline
    setInterval(() => {
      if (Date.now() - lastMsg > TIMEOUT) {
        document.getElementById('statusDot').classList.remove('online');
      }
    }, 3000);
  </script>
</body>
</html>
