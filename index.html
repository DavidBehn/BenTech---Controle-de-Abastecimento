<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Controle de Abastecimento - BenTech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="https://davidbehn.github.io/bentech-assets/favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background-color: #000; overflow-x: hidden; }
    body {
      font-family: Arial, sans-serif; color: #fff; text-align: center;
      background: linear-gradient(rgba(0,0,0,0.70), rgba(0,0,0,0.70)),
                  url('https://davidbehn.github.io/bentech-assets/bg.jpg') center top/cover no-repeat fixed;
    }
    body::before {
      content: ""; position: fixed; top: -50%; left: 0; height: 200%;
      background: url('https://davidbehn.github.io/bentech-assets/bg.jpg') center/cover no-repeat fixed;
    }
    @supports (-webkit-touch-callout: none) { html, body { height: -webkit-fill-available; } }
    .header {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      background: rgba(17,17,17,0.9); padding: 10px 15px; margin: 15px auto;
      border-radius: 10px; width: 90%; max-width: 405px; flex-wrap: wrap;
    }
    .header img { width: 40px; height:40px; }
    h1 { font-size: 20px; margin: 0; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%; background: #ff4444;
      box-shadow: 0 0 0 10px #ff4444; animation: pulse-red 2s infinite;
    }
    .online { background: #00ff88 !important; box-shadow: 0 0 15px #00ff88 !important; animation: pulse-green 2s infinite !important; }
    @keyframes pulse-red { 0%,100% { opacity: 0.7; } 50% { opacity: 1; } }
    @keyframes pulse-green { 0%,100% { opacity: 0.8; } 50% { opacity: 1; } }
    .card {
      background: rgba(51,51,51,0.7); padding: 20px; margin: 15px auto;
      border-radius: 15px; width: 90%; max-width: 420px;
    }
    .button {
      display: inline-block; padding: 15px 25px; margin: 10px; border: none;
      border-radius: 10px; font-size: 18px; cursor: pointer; width: 40%;
      max-width: 200px; transition: all 0.2s;
    }
    .on { background: #00ff88; color: #000; }
    .on:active { background: #00cc66; transform: scale(0.97); }
    .off { background: #ff4444; color: #fff; }
    .off:active { background: #cc3333; transform: scale(0.97); }
    select { padding: 10px; font-size: 16px; border-radius: 8px; width: 120px; }
    #msg, #saveMsg { margin-top: 10px; font-size: 16px; color: #fff; display: none; }
    .status-text { font-size: 18px; margin-top: 5px; }
    .inline-group { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 10px; }

    /* TANQUES */
    .tanks-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px auto 10px;
      padding: 0 10px;
    }
    .tank-wrapper {
      flex: 1;
      max-width: 190px;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tank-label {
      font-weight: bold;
      font-size: 16px;
      color: #bbddff;
      text-shadow: 0 2px 8px #000;
      margin-bottom: 14px;
      letter-spacing: 0.5px;
    }
    .tank-container {
      width: 100%;
      padding-bottom: 150%;
      position: relative;
      background: rgba(20,30,50,0.6);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.7),
                  inset 0 0 20px rgba(0,120,255,0.2);
    }
    .tank {
      position: absolute;
      inset: 6px;
      border-radius: 16px;
      background: linear-gradient(135deg, #1a2640, #0c1424);
      overflow: hidden;
      border: 2px solid #336699;
    }

    /* ÁGUA COM ONDULAÇÃO NA LINHA (EXATAMENTE COMO SMART LIFE) */
    .water {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, #005a99, #0af);
      transition: height 1.8s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Camada de ondulação suave na superfície */
    .water-wave {
      position: absolute;
      top: -15px;
      left: 0;
      width: 100%;
      height: 40px;
      background: linear-gradient(transparent, rgba(255,255,255,0.4));
      border-radius: 50%;
      animation: waveSurface 8s ease-in-out infinite;
      transform-origin: center bottom;
    }

    .water-wave:nth-child(2) {
      animation-delay: -4s;
      opacity: 0.6;
      transform: scale(0.95);
    }

    @keyframes waveSurface {
      0%, 100% { transform: translateY(0) scaleY(1); }
      50%      { transform: translateY(-8px) scaleY(1.08); }
    }

    /* Ondas internas suaves rolando */
    .water::before,
    .water::after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 120%;
      background: repeating-linear-gradient(
        90deg,
        transparent 0%,
        transparent 15%,
        rgba(255,255,255,0.08) 20%,
        rgba(255,255,255,0.08) 30%,
        transparent 35%
      );
      animation: flow 20s linear infinite;
    }
    .water::after {
      animation-duration: 26s;
      animation-direction: reverse;
      opacity: 0.5;
    }
    @keyframes flow {
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* Brilho delicado no topo */
    .water > .shine {
      position: absolute;
      top: 8px;
      left: 10%;
      width: 80%;
      height: 35px;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.6) 0%, transparent 70%);
      border-radius: 50%;
      opacity: 0.5;
      animation: shine 7s ease-in-out infinite;
    }
    @keyframes shine {
      0%,100% { opacity: 0.4; transform: scale(1); }
      50%     { opacity: 0.6; transform: scale(1.05); }
    }

    /* Porcentagem (exatamente como aprovado) */
    .level-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 34px;
      font-weight: 600;
      color: #ffffff;
      text-shadow: 0 0 20px rgba(0,0,0,0.9), 0 2px 8px rgba(0,0,0,0.8);
      letter-spacing: 1.5px;
      z-index: 20;
      pointer-events: none;
    }

    @media (max-width: 380px) {
      .level-text { font-size: 30px; }
      .tank-label { font-size: 15px; }
      .tanks-row { gap: 15px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://davidbehn.github.io/bentech-assets/logo.png" alt="BenTech">
    <h1>Controle de Abastecimento</h1>
    <div id="statusDot" class="status-dot"></div>
  </div>

  <div class="card">
    <h2>Níveis de Reservatório</h2>
    <div class="tanks-row">
      <!-- Caixa d'Água -->
      <div class="tank-wrapper">
        <div class="tank-label">Caixa d'Água</div>
        <div class="tank-container">
          <div class="tank">
            <div id="waterTankWater" class="water">
              <div class="water-wave"></div>
              <div class="water-wave"></div>
              <div class="shine"></div>
            </div>
            <div id="waterTankPercent" class="level-text">0%</div>
          </div>
        </div>
      </div>

      <!-- Reservatório -->
      <div class="tank-wrapper">
        <div class="tank-label">Reservatório</div>
        <div class="tank-container">
          <div class="tank">
            <div id="reservoirWater" class="water">
              <div class="water-wave"></div>
              <div class="water-wave"></div>
              <div class="shine"></div>
            </div>
            <div id="reservoirPercent" class="level-text">0%</div>
          </div>
        </div>
      </div>
    </div>
    <p style="font-size:14px; margin-top:20px;">Obs: O reservatório precisa estar acima<br>de 25% para acionamento automático</p>
  </div>

  <!-- Todo o resto do código 100% igual ao seu original -->
  <div class="card">
    <h2>Bomba Automática</h2>
    <p>Nível para ligar automaticamente</p>
    <div class="inline-group">
      <select id="selector">
        <option value="0">0%</option>
        <option value="25">25%</option>
        <option value="50">50%</option>
        <option value="75">75%</option>
        <option value="99">OFF</option>
      </select>
      <button class="button on" onclick="saveValue()">Salvar</button>
    </div>
    <p id="saveMsg" class="status-text"></p>
  </div>

  <div class="card">
    <h2>Bomba Manual</h2>
    <button class="button on" onclick="sendCommand('pump:on', true)">Ligar</button>
    <button class="button off" onclick="sendCommand('pump:off', false)">Desligar</button>
    <p id="msg" class="status-text"></p>
    <p id="pumpStatus" class="status-text" style="color:#ff4444">Desligado</p>
  </div>

  <div class="card">
    <h2>Dispositivo Paralelo</h2>
    <button class="button on" onclick="sendCommand('device:on', true, 'deviceStatus')">Ligar</button>
    <button class="button off" onclick="sendCommand('device:off', false, 'deviceStatus')">Desligar</button>
    <p id="deviceStatus" class="status-text" style="color:#ff4444">Desligado</p>
  </div>

  <script>
    const CLIENTE = "David";
    const base = "Bentech/" + CLIENTE + "/abastecimento";
    const topicCmd = base + "/cmd";
    const topicStatus = base + "/status";
    const topicTrigger = base + "/trigger";
    const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
    const clientId = 'web_' + Date.now();
    const client = mqtt.connect(mqttBroker, { clientId, keepalive: 30, reconnectPeriod: 3000 });
    let lastMessageTime = 0;
    const TIMEOUT = 10000;

    function setOnline() {
      document.getElementById('statusDot').classList.add('online');
      lastMessageTime = Date.now();
    }
    function checkStatus() {
      if (Date.now() - lastMessageTime > TIMEOUT) {
        document.getElementById('statusDot').classList.remove('online');
      }
    }
    client.on('connect', () => {
      console.log("Conectado ao broker MQTT");
      client.subscribe([topicStatus, topicTrigger]);
      setInterval(checkStatus, 5000);
    });
    client.on('message', (topic, message) => {
      setOnline();
      if (topic === topicStatus) {
        try {
          const data = JSON.parse(message.toString());
          if (data.waterTankLevel !== undefined) updateTank('waterTankWater', 'waterTankPercent', data.waterTankLevel);
          if (data.reservoirLevel !== undefined) updateTank('reservoirWater', 'reservoirPercent', data.reservoirLevel);
          if (data.pumpStatus !== undefined) updateStatus('pumpStatus', data.pumpStatus);
          if (data.deviceStatus !== undefined) updateStatus('deviceStatus', data.deviceStatus);
        } catch(e) { console.error(e); }
      }
      if (topic === topicTrigger) {
        let val = parseInt(message.toString());
        document.getElementById('selector').value = (val >= 99 ? 99 : val);
      }
    });

    function updateTank(waterId, percentId, level) {
      level = Math.max(0, Math.min(100, Math.round(level)));
      const water = document.getElementById(waterId);
      const percentEl = document.getElementById(percentId);
      water.style.height = level + '%';
      percentEl.textContent = level + '%';
      if (level < 20) {
        water.style.background = 'linear-gradient(to top, #990000, #ff4444)';
      } else if (level < 50) {
        water.style.background = 'linear-gradient(to top, #cc7700, #ffaa00)';
      } else {
        water.style.background = 'linear-gradient(to top, #005a99, #0af)';
      }
    }

    function sendCommand(cmd, state, statusId = 'pumpStatus') {
      client.publish(topicCmd, cmd);
      if ("vibrate" in navigator) navigator.vibrate(50);
      if (statusId) {
        const el = document.getElementById(statusId);
        el.innerText = state ? 'Ligado' : 'Desligado';
        el.style.color = state ? '#00ff88' : '#ff4444';
      }
    }
    function saveValue() {
      client.publish(topicCmd, 'trigger:' + document.getElementById('selector').value);
      if ("vibrate" in navigator) navigator.vibrate(50);
      const msg = document.getElementById('saveMsg');
      msg.innerText = 'Salvo!';
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 2000);
    }
  </script>
</body>
</html>
